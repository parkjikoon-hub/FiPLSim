# 소화배관 시뮬레이터 개발 로드맵

> 작성일: 2026-02-25
> 현재 버전: v1.0 (Core + Weld Bead Feature)

---

## 현재 구현 완료 현황 (v1.0)

| 기능 | 상태 | 테스트 |
|------|------|--------|
| 수리계산 엔진 (Darcy-Weisbach, Colebrook-White) | 완료 | 통과 |
| 동적 배관망 생성 (n가지 x m헤드) | 완료 | 통과 |
| 교차배관 압력 계산 | 완료 | 통과 |
| Case A vs B 비교 (기존 vs 신기술) | 완료 | 통과 |
| 직관 용접 비드 (WeldBead) 모델링 | 완료 | 통과 |
| 몬테카를로 시뮬레이션 (비드 위치 랜덤화) | 완료 | 통과 |
| 민감도 분석 (임계점 탐색) | 완료 | 통과 |
| 펌프 P-Q 곡선 연동 (3개 모델) | 완료 | 통과 |
| 운전점 계산 (Brent 법) | 완료 | 통과 |
| 에너지 절감 계산 | 완료 | 통과 |
| Streamlit UI (5개 탭 대시보드) | 완료 | 수동 확인 |
| 데이터 내보내기 (Excel 8시트 + CSV) | 완료 | 수동 확인 |
| 입력 검증 (ValidationError) | 완료 | 통과 |
| 통합 테스트 (84개) | 완료 | 전체 통과 |

---

## PRD 대비 미구현 항목 (Gap Analysis)

| PRD 요구사항 | 현재 상태 | 우선순위 |
|-------------|----------|---------|
| 효율 곡선 (eta-Q) 기반 정밀 LCC 계산 | 단일 BEP 효율값만 사용 | 높음 |
| 펌프 다운사이징 가능성 리포트 | 미구현 | 높음 |
| 전문 용어 Tooltip (마우스 오버 설명) | 부분 구현 | 중간 |
| 임계점 히트맵 (위치 x 비드높이 조합) | 막대 차트만 존재 | 중간 |

---

## Phase 1: PRD 완성 + 핵심 고도화 (v1.1)

> 목표: PRD에서 요구했으나 아직 구현하지 못한 기능을 완성하고,
> 시뮬레이션의 정밀도와 설득력을 높이는 단계

### 1-1. 효율 곡선 (eta-Q) 도입

- **현재**: 펌프 효율을 단일 값(예: Wilo 78%)으로 고정 사용
- **개선**: 유량별 효율이 변하는 eta-Q 곡선 보간 적용
- **효과**: 운전점에서의 실제 효율로 소요 동력을 정밀 계산 -> LCC 정확도 향상
- **작업 범위**:
  - `constants.py`: PUMP_DATABASE에 eta-Q 데이터 포인트 추가
  - `pump.py`: PumpCurve 클래스에 efficiency_at_flow(Q) 메서드 추가
  - `pump.py`: find_operating_point()에서 운전점 효율 반영
  - `app.py`: P-Q 탭에 효율 곡선 오버레이 표시 (보조 Y축)

### 1-2. 펌프 다운사이징 분석 리포트

- **현재**: Case A/B 에너지 절감만 표시
- **개선**: 신기술 적용 시 더 작은 펌프로도 0.1MPa를 만족하는지 자동 비교
- **효과**: "형상제어 기술 도입 시 Model C로 다운사이징 가능" 같은 실무 결론 도출
- **작업 범위**:
  - `pump.py`: analyze_downsizing(current_pump, systems_list) 함수 추가
  - `app.py`: P-Q 탭에 "다운사이징 분석" 섹션 추가
  - 3개 펌프 모두에 대해 Case B 운전점 + 0.1MPa 충족 여부 자동 비교

### 1-3. 임계점 2D 히트맵 (위치 x 비드높이)

- **현재**: 민감도 분석이 단일 비드 높이에서 위치별 영향도만 표시
- **개선**: 비드 높이(0.5~3.0mm)와 위치(헤드 1~m)의 조합별 압력 강하 히트맵
- **효과**: "어느 위치에 어느 크기의 비드가 가장 치명적인지" 2D로 한눈에 파악
- **작업 범위**:
  - `simulation.py`: run_heatmap_analysis(bead_range, positions) 함수 추가
  - `app.py`: 민감도 탭에 Plotly heatmap 차트 추가

### 1-4. 전문 용어 Tooltip 강화

- **현재**: 일부 용어에만 설명 존재
- **개선**: 모든 전문 용어(주손실, 부차손실, K-factor, Re, MPa 등)에 마우스 오버 설명
- **작업 범위**:
  - `app.py`: tooltip 헬퍼 함수 작성
  - 사이드바 + 본문의 모든 전문 용어에 HTML title 속성 적용

---

## Phase 2: 사용자 경험(UX) 강화 (v1.2)

> 목표: 비개발자 사용자가 시뮬레이션 결과를 외부에 보고/발표할 수 있도록
> 리포트 생성 및 사용 편의성을 높이는 단계

### 2-1. PDF 보고서 자동 생성

- **현재**: Excel/CSV 데이터만 내보내기 가능
- **개선**: 차트 + 테이블 + 결론이 포함된 전문 PDF 보고서 1-click 생성
- **효과**: 경영진/고객 대상 보고서를 별도 작업 없이 바로 추출
- **작업 범위**:
  - 새 모듈 `report.py`: PDF 생성 엔진 (fpdf2 또는 reportlab 라이브러리)
  - 보고서 구성: 표지 -> 요약 -> 압력 프로파일 -> P-Q 곡선 -> MC 통계 -> 결론
  - `app.py`: 데이터 추출 탭에 "PDF 보고서 다운로드" 버튼 추가

### 2-2. 건물 유형별 프리셋 (Quick Preset)

- **현재**: 모든 변수를 수동 입력
- **개선**: 건물 유형 선택 시 자동으로 권장 설정 입력
- **효과**: 비전문가도 "오피스텔 20층"을 선택하면 적절한 배관망 설정 자동 적용
- **프리셋 예시**:
  - 소규모 주택 (2가지 x 4헤드, 100LPM)
  - 아파트 (8가지 x 8헤드, 400LPM)
  - 오피스 빌딩 (20가지 x 10헤드, 800LPM)
  - 대형 공장/창고 (50가지 x 12헤드, 1500LPM)
- **작업 범위**:
  - `constants.py`: BUILDING_PRESETS 딕셔너리 추가
  - `app.py`: 사이드바 상단에 프리셋 선택 드롭다운 추가

### 2-3. 시나리오 저장 및 비교

- **현재**: 시뮬레이션 결과가 세션 내에서만 존재
- **개선**: 여러 시나리오를 저장하고 나란히 비교할 수 있는 기능
- **효과**: "배관 간격 2.3m vs 3.4m" 같은 설계 대안을 정량적으로 비교
- **작업 범위**:
  - `app.py`: session_state에 시나리오 리스트 관리
  - 새 탭 또는 팝업에서 저장된 시나리오 테이블 비교
  - JSON 파일로 시나리오 내보내기/불러오기

### 2-4. 시뮬레이션 진행 상황 표시 개선

- **현재**: 몬테카를로 실행 중 진행 상황이 보이지 않음
- **개선**: Streamlit progress bar + 예상 남은 시간 표시
- **작업 범위**:
  - `simulation.py`: 콜백 함수 인자 추가
  - `app.py`: st.progress() 연동

---

## Phase 3: 공학적 정밀도 심화 (v1.3)

> 목표: 실제 현장 조건을 반영하여 시뮬레이션 정밀도를 높이고,
> 법규 준수 여부를 자동 검증하는 단계

### 3-1. 배관 노후화/부식 계수 반영

- **현재**: 탄소강 조도(0.045mm)를 신품 기준으로 고정 사용
- **개선**: 사용 연수(0~30년)에 따른 조도 증가 모델 적용
- **효과**: "10년 후 배관 상태에서도 0.1MPa를 만족하는가?" 검증 가능
- **작업 범위**:
  - `constants.py`: AGING_ROUGHNESS_TABLE (연수별 조도 배율)
  - `hydraulics.py`: friction_factor()에 aging_factor 인자 추가
  - `app.py`: 사이드바에 "배관 사용 연수" 슬라이더 추가

### 3-2. 수직 배관 (층간 양정) 고려

- **현재**: 수평 배관만 계산 (고도차 없음)
- **개선**: 건물 층수와 층고를 입력하면 정수압(rho*g*h) 자동 반영
- **효과**: 고층 건물에서 상층부 압력 부족 문제 사전 예측
- **작업 범위**:
  - `pipe_network.py`: BranchPipe에 elevation_m 속성 추가
  - `pipe_network.py`: _calculate_branch_profile()에 위치수두 계산 추가
  - `app.py`: "건물 층수 / 층고" 입력란 추가

### 3-3. 사용자 정의 펌프 곡선 입력

- **현재**: 3개 내장 펌프 모델만 선택 가능
- **개선**: 사용자가 P-Q 데이터 포인트를 직접 입력하여 커스텀 펌프 등록
- **효과**: 실제 현장에 설치된 펌프 기준으로 정확한 분석
- **작업 범위**:
  - `app.py`: 사이드바에 "커스텀 펌프" 입력 폼 (유량-양정 쌍 입력)
  - `pump.py`: 입력값 검증 및 PumpCurve 자동 생성
  - CSV 파일에서 펌프 곡선 불러오기 기능

### 3-4. NFSC 103 / NFPA 13 준수 자동 체커

- **현재**: 관경 자동 선정만 구현 (NFSC 103 기반)
- **개선**: 설계 기준 전체 항목(최소 유량, 최소 압력, 배관 간격 한계 등) 자동 점검
- **효과**: "이 설계가 법규를 만족하는가?" 체크리스트를 자동으로 생성
- **작업 범위**:
  - 새 모듈 `compliance.py`: 기준 데이터 + 검증 로직
  - `app.py`: 결과 화면에 "법규 준수 현황" 패널 추가 (Pass/Fail 항목별 표시)

---

## Phase 4: 시각화 및 분석 확장 (v1.4)

> 목표: 데이터를 더 직관적으로 보여주고,
> 고급 분석 기능을 제공하는 단계

### 4-1. 배관망 2D/3D 시각화

- **현재**: ASCII 아트로 배관 구조 표현
- **개선**: 교차배관 + 가지배관의 2D 도면을 인터랙티브 차트로 표시
  - 각 구간의 색상으로 압력/유속 표현
  - 클릭 시 해당 구간의 상세 정보 표시
- **작업 범위**:
  - `app.py`: Plotly scatter/line으로 2D 배관 레이아웃 구현
  - 색상 매핑: 압력(빨강=위험, 초록=안전), 유속 그라데이션

### 4-2. 몬테카를로 결과 고급 분석

- **현재**: 히스토그램 + 박스플롯 + 결함 빈도
- **개선 항목**:
  - 신뢰구간 표시 (90%, 95%, 99%)
  - 누적분포함수(CDF) 그래프
  - 최악 시나리오 Top 5 상세 표시
  - 수렴도 그래프 (반복 횟수 vs 평균값 안정화)
- **작업 범위**:
  - `simulation.py`: 추가 통계값 산출 (신뢰구간, 분위수)
  - `app.py`: MC 탭에 서브 탭 또는 확장 섹션 추가

### 4-3. 비드 높이 범위별 자동 스캔

- **현재**: 사용자가 하나의 비드 높이를 지정
- **개선**: 0.0~3.0mm 범위를 자동으로 스캔하여 "비드 높이 vs 말단 압력" 곡선 생성
- **효과**: "비드가 몇 mm까지 허용 가능한지" 임계값을 자동으로 파악
- **작업 범위**:
  - `simulation.py`: run_bead_height_sweep() 함수 추가
  - `app.py`: 새 차트 - X축: 비드높이, Y축: 말단압력, 0.1MPa 기준선 표시

### 4-4. 다중 펌프 동시 비교 차트

- **현재**: 한 번에 1개 펌프만 선택
- **개선**: 3개 펌프를 동시에 P-Q 차트에 오버레이하여 비교
- **효과**: 펌프 선정 의사결정을 한 화면에서 수행
- **작업 범위**:
  - `app.py`: P-Q 탭에 "전체 펌프 비교 모드" 토글 추가
  - 각 펌프별 운전점, 소요동력, 에너지비용 비교 테이블

---

## Phase 5: 플랫폼 확장 (v2.0)

> 목표: 단일 시뮬레이터에서 협업 가능한 플랫폼으로 확장하는 장기 비전

### 5-1. 시뮬레이션 결과 DB 저장

- 실행 결과를 SQLite/PostgreSQL에 영구 저장
- 날짜별, 프로젝트별 결과 조회 및 추세 분석

### 5-2. 사용자 인증 및 프로젝트 관리

- 로그인 기능으로 개인별 시뮬레이션 이력 관리
- 프로젝트 단위로 시나리오 그룹핑

### 5-3. REST API 제공

- 외부 시스템(BIM, 설계 CAD)에서 시뮬레이션을 호출할 수 있는 API
- `FastAPI` 기반 엔드포인트 구현

### 5-4. 클라우드 배포

- Streamlit Cloud 또는 AWS/GCP 배포
- 팀 단위 동시 접속 지원

---

## 권장 개발 순서 요약

```
v1.0 [현재] ── 핵심 시뮬레이션 완성, 84개 테스트 통과
  |
v1.1 [Phase 1] ── PRD 완성: eta-Q, 다운사이징, 히트맵, Tooltip
  |
v1.2 [Phase 2] ── UX 강화: PDF 보고서, 건물 프리셋, 시나리오 비교
  |
v1.3 [Phase 3] ── 정밀도: 노후화, 수직배관, 커스텀 펌프, 법규 체커
  |
v1.4 [Phase 4] ── 시각화: 2D 배관도, MC 고급분석, 비드 스캔, 펌프 비교
  |
v2.0 [Phase 5] ── 플랫폼: DB, 인증, API, 클라우드
```

---

## 파일 변경 예상 범위

| Phase | constants.py | hydraulics.py | pipe_network.py | pump.py | simulation.py | app.py | 신규 파일 |
|-------|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
| 1.1 eta-Q | O | - | - | O | - | O | - |
| 1.2 다운사이징 | - | - | - | O | - | O | - |
| 1.3 히트맵 | - | - | - | - | O | O | - |
| 1.4 Tooltip | - | - | - | - | - | O | - |
| 2.1 PDF 보고서 | - | - | - | - | - | O | report.py |
| 2.2 건물 프리셋 | O | - | - | - | - | O | - |
| 3.1 노후화 | O | O | - | - | - | O | - |
| 3.2 수직배관 | - | - | O | - | - | O | - |
| 3.3 커스텀 펌프 | - | - | - | O | - | O | - |
| 3.4 법규 체커 | - | - | - | - | - | O | compliance.py |
| 4.1 2D 시각화 | - | - | - | - | - | O | - |

---

## 기술 부채 (Technical Debt) 관리

| 항목 | 설명 | 대응 시기 |
|------|------|----------|
| 레거시 함수 | build_default_network, run_monte_carlo 등 8헤드 고정 함수 | Phase 2 이후 deprecated 처리 |
| 단일 파일 UI | app.py가 28KB로 비대 | Phase 2에서 페이지 분리 (st.navigation) |
| 하드코딩 펌프 DB | constants.py에 3개 모델 직접 기입 | Phase 3에서 외부 JSON/DB로 분리 |
| 테스트 자동화 | 수동 실행만 가능 | CI/CD 도입 시 pytest 전환 고려 |
